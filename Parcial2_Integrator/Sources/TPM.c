/*! **********************************************************************************************
* 2014  ITESM Campus Guadalajara. Laboratorio de Microcontroladores 
*  
*
* @file:      TPM.c
* @author(s):  
* Abner Pérez Haro A01224776
* Juan Carlos Pérez Castellanos A01225629
* 
* @brief (Theory of Operation)
*
**************************************************************************************************/


/*************************************************************************************************/
/*********************						Includes						**********************/
/*************************************************************************************************/
#include "derivative.h"
/*************************************************************************************************/
/*********************						Defines							**********************/
/*************************************************************************************************/
#define initial_config 0b01000010
#define stopH 14
#define stopL 58
#define startMask 0x08
#define stopMask 0x0F7
#define numFlagsMin 1
#define numFlagsMax 200
/*************************************************************************************************/
/*********************						Typedefs						**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************					Function Prototypes					**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Variables                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************					Global Variables					**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Constants                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Global Constants                    **********************/
/*************************************************************************************************/
char gu8flagCounter = 0;
char gu8flagsPDelay = 0;
char gu8running = 0;
/*************************************************************************************************/
/*********************				   Exported Functions					**********************/
/*************************************************************************************************/

void TPM_Init(void)
{
	//Set initial configuration:
	//*Enable flag interrupt
	//*No clock source selected
	//*Prescale divisor 1/4
	TPMSC = initial_config;
	
	//Timer limit value to get a 5208us timer
	TPMMODH = stopH;
	TPMMODL = stopL;
	
	//Reset flag counters
	gu8flagCounter = 0;
	gu8flagsPDelay = numFlagsMin;
	
	//Timer is stopped
	gu8running = 0;
}

void TPM_Start(void)
{
	if(!gu8running)
	{
		//Bus clock as source selected
		TPMSC |= startMask;
		gu8running = ~gu8running&0x01;
	}	
}

void TPM_Stop(void)
{
	if(gu8running)
	{
		//No clock source selected
		TPMSC &= stopMask;
		gu8running = ~gu8running&0x01;
	}
}

char TMP_isRunning(void)
{
	return gu8running;
}

void TPM_SetLimitFlags(char u8numFlags)
{
	if(!gu8running)
	{
		if((u8numFlags >= numFlagsMin) && (u8numFlags <= numFlagsMax))
		{
			gu8flagsPDelay = u8numFlags;
		}
	}
}

/*************************************************************************************************/
/*********************				    Private Functions					**********************/
/*************************************************************************************************/

interrupt 7 void TMP_ISR(void)
{
	TPMSC_TOF = 0;
	if(gu8flagCounter < gu8flagsPDelay)
	{
		gu8flagCounter++;
	}
	else
	{
		gu8flagCounter = 0;
		gu8running = 0;	
	}
}
