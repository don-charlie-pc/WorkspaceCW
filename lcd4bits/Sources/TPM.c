/*! **********************************************************************************************
* 2014  ITESM Campus Guadalajara. Laboratorio de Microcontroladores 
*  
*
* @file:      TPM.c
* @author(s):  
* Abner Pérez Haro A01224776
* Juan Carlos Pérez Castellanos A01225629
* 
* @brief (Theory of Operation)
*
**************************************************************************************************/


/*************************************************************************************************/
/*********************						Includes						**********************/
/*************************************************************************************************/
#include "derivative.h"
/*************************************************************************************************/
/*********************						Defines							**********************/
/*************************************************************************************************/
#define INITIAL_CONFIG 0b01000010
#define START_MASK 0x08
#define STOP_MASK 0x0F7
#define MIN_NUM_OF_FLAGS 1
#define MAX_NUM_OF_FLAGS 200
/*************************************************************************************************/
/*********************						Typedefs						**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************					Function Prototypes					**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Variables                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************					Global Variables					**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Constants                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Global Constants                    **********************/
/*************************************************************************************************/
char gu8flagCounter = 0;
char gu8flagsPDelay = 0;
char gu8running = 0;
/*************************************************************************************************/
/*********************				   Exported Functions					**********************/
/*************************************************************************************************/

void TPM_Init(void)
{
	//Set initial configuration:
	//*Enable flag interrupt
	//*No clock source selected
	//*Prescale divisor 1/4
	TPMSC = INITIAL_CONFIG;
	
	//Reset Timer Module
	TPMMODH = 0;
	TPMMODL = 0;
	
	//Reset flag counters
	gu8flagCounter = 0;
	gu8flagsPDelay = MIN_NUM_OF_FLAGS;
	
	//Timer is stopped
	gu8running = 0;
}

void TPM_SetLimitFlags(char u8numFlags)
{
	if(!gu8running)
	{
		//Only if u8numFlags is in the allowed range
		if((u8numFlags >= MIN_NUM_OF_FLAGS) && (u8numFlags <= MAX_NUM_OF_FLAGS))
		{
			gu8flagsPDelay = u8numFlags;
		}
	}
}

void TPM_SetMicroSecPFlag(unsigned int u16microSec)
{
	//Store u16microSec in timer module
	TPMMODL = (char)u16microSec;
	TPMMODH = (char)(u16microSec >> 8);
}

void TPM_Start(void)
{
	if(!gu8running)
	{
		//Bus clock as source selected
		TPMSC |= START_MASK;
		//Toggle running flag
		gu8running = ~gu8running&0x01;
	}	
}

void TPM_Stop(void)
{
	if(gu8running)
	{
		//No clock source selected
		TPMSC &= STOP_MASK;
		//Toggle running flag
		gu8running = ~gu8running&0x01;
	}
}

char TMP_isRunning(void)
{
	return gu8running;
}

/*************************************************************************************************/
/*********************				    Private Functions					**********************/
/*************************************************************************************************/

interrupt 7 void TMP_ISR(void)
{
	TPMSC_TOF = 0;
	if(gu8flagCounter < gu8flagsPDelay)
	{
		gu8flagCounter++;
	}
	else
	{
		//TODO 
		gu8flagCounter = 0;
		gu8running = 0;	
		TPM_Stop();
	}
}
