/*! **********************************************************************************************
* 2014  ITESM Campus Guadalajara. Laboratorio de Microcontroladores 
*  
*
* @file:      EncoderManager.c
* @author(s):  
*Juan Carlos Perez Castellanos A01225629
*
* @brief (Theory of Operation)
*
**************************************************************************************************/


/*************************************************************************************************/
/*********************						Includes						**********************/
/*************************************************************************************************/
#include "TPM.h"
/*************************************************************************************************/
/*********************						Defines							**********************/
/*************************************************************************************************/
#define DIVIDED_BY_128 7
#define K 7812
/*************************************************************************************************/
/*********************						Typedefs						**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************					Function Prototypes					**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Variables                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************					Global Variables					**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Constants                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Global Constants                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************				   Exported Functions					**********************/
/*************************************************************************************************/

void EncoderManager_Init(void)
{
	//Set up TPM
	TPM_Init();
	TPM_SetPrescaler(DIVIDED_BY_128);
	TPM_EnableInputCaptureCH0();
	TPM_EnableInputCaptureCH1();
	//Synchronise rising input capture edge with TPM counter
	TPM_Start();
	(void)TPM_getCH0Val();
	TPM_ResetStepCounter();
	TPM_Reset();
}

void EncoderManager_GetData(unsigned int *u16speed, char *u8dir, char *u8step)
{
	unsigned int u16CH0Value = TPM_getCH0Val();
	unsigned int u16CH1Value = TPM_getCH1Val();
	TPM_Reset(); //Synchronise TPM counter again
	*u16speed = (u16CH0Value/10) * K; //Get RPM speed from CH0 value. 
	*u8dir = (u16CH0Value > u16CH1Value); //Get direction from the difference between the read values.
	TPM_SetDir(*u8dir); //Update the step counter of TPM (increment or decrement).
	*u8step = TPM_GetStep();
}

/*************************************************************************************************/
/*********************				    Private Functions					**********************/
/*************************************************************************************************/

