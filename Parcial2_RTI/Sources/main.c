/*! **********************************************************************************************
* 2014  ITESM Campus Guadalajara. Laboratorio de Microcontroladores 
*  
*
* @file:      main.c
* @author(s):  
* Abner Perez Haro A01224776
* Juan Carlos Perez Castellanos A01225629
* 
* @brief (Theory of Operation)
* First, this module initialises Stepper Motor, Speed Manager and Delay Manager ECU.
* Then it enters to an infinite loop where:
* -It checks the motor speed with Speed Manager,
* -executes a delay according to the selected speed with Delay Manager
* -and updates the stepper sequence and the motor direction with Stepper Motor.
**************************************************************************************************/

/*************************************************************************************************/
/*********************						Includes						**********************/
/*************************************************************************************************/
#include <hidef.h> /* for EnableInterrupts macro */
#include "derivative.h" /* include peripheral declarations */
#include "StepperMotor.h"
#include "SpeedManager.h"
#include "DelayManager.h"

/*************************************************************************************************/
/*********************						Defines							**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************						Typedefs						**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************					Function Prototypes					**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Variables                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************					Global Variables					**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Constants                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Global Constants                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************				   Exported Functions					**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************				    Private Functions					**********************/
/*************************************************************************************************/

void main(void) {
	
	//Set up ECU Layer 
	StepperMotor_Init();
	SpeedManager_Init();
	DelayManager_Init();
	EnableInterrupts;
  
	for(;;)
	{
	  __RESET_WATCHDOG();
	  
	  //Set a time delay according the current motor speed
	  (void)DelayManager_SetDelayBySpeed(SpeedManager_ReadSpeed());
	  
	  //Wait before change to the next step
	  DelayManager_Delay();
	  
	  //Check input if it is necessary to change the motor direction
	  StepperMotor_NextStep();
	  StepperMotor_RefreshDirection(); 
	}
}
